// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Threading.Tasks;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using UpdateVulnerabilityData.Storage;

namespace UpdateVulnerabilityData.CWE
{
    public class CweDataClient : VulnerabilityDataClient, ICweDataClient
    {
        private static readonly string _localDataImportFolder = Path.Combine(Environment.CurrentDirectory, "CWE-data-import");
        private static readonly string _localDataExportFolder = Path.Combine(Environment.CurrentDirectory, "CWE-data-export");
        private static readonly string _pathToDownloadedArchive = Path.Combine(_localDataImportFolder, "cwe-data.zip");

        private readonly ICweCsvFileParser _csvFileParser;
        private readonly ICweDataDownloader _cweDataDownloader;

        public CweDataClient(
            ICweCsvFileParser csvFileParser,
            ICweDataDownloader cweDataDownloader,
            ILogger<CweDataClient> logger,
            IOptionsSnapshot<UpdateVulnerabilityDataConfiguration> configuration,
            IBackupDestination backupDestination)
            : base(configuration, logger, backupDestination)
        {
            _csvFileParser = csvFileParser ?? throw new ArgumentNullException(nameof(csvFileParser));
            _cweDataDownloader = cweDataDownloader ?? throw new ArgumentNullException(nameof(cweDataDownloader));
        }

        public async Task ImportCweDataAsync(Func<Task<SqlConnection>> sqlConnectionFactory)
        {
            if (sqlConnectionFactory == null)
            {
                throw new ArgumentNullException(nameof(sqlConnectionFactory));
            }

            // Ensure the target folders exist and are clean.
            PrepareLocalDirectories(_localDataImportFolder, _localDataExportFolder);

            // Fetch CWE data for the 'Development Concepts' view.
            var downloadResult = await _cweDataDownloader.DownloadAndExtractCsvDataToDiskAsync(_pathToDownloadedArchive);

            // Parse the CSV-formatted source file.
            var csvDocument = _csvFileParser.Parse(downloadResult.PathToJsonFile);

            // Export to JSON.
            SaveProjectedJsonFileToDisk(csvDocument);

            // Import projected data into database.
            await ImportIntoDatabaseAsync(sqlConnectionFactory, csvDocument);

            // Save source data to backup location.
            await BackupSourceDataAsync(_pathToDownloadedArchive, downloadResult.ETag);
        }

        private async Task BackupSourceDataAsync(string sourceFilePath, string eTag)
        {
            var fileInfo = new FileInfo(sourceFilePath);
            using (var fileStream = File.OpenRead(sourceFilePath))
            {
                await BackupDestination.WriteAsync(fileStream, fileInfo.Name, ContentType.Zip, eTag);
            }
        }

        private void SaveProjectedJsonFileToDisk(CweCsvDocument csvDocument)
        {
            var targetFilePath = Path.Combine(_localDataExportFolder, $"cwe.json");
            var json = CweJsonFileExporter.RenderJson(csvDocument);
            File.WriteAllText(targetFilePath, json);
        }

        private async Task ImportIntoDatabaseAsync(
            Func<Task<SqlConnection>> sqlConnectionFactory,
            CweCsvDocument csvDocument)
        {
            // Import assumes clear target tables.
            using (var sqlConnection = await sqlConnectionFactory())
            {
                var dataTable = GetDataTable(SqlTable.Cwes, sqlConnection);

                foreach (var cwe in csvDocument.Entries)
                {
                    var cweId = $"CWE-{cwe.CweId}";

                    var dataRow = dataTable.NewRow();
                    dataRow["CweId"] = cweId;
                    dataRow["Name"] = cwe.Name;
                    dataRow["Description"] = cwe.Description;

                    var status = CweHelper.DetermineStatus(cwe.Status);
                    dataRow["Status"] = status;
                    dataRow["Listed"] = CweHelper.DetermineListed(status);

                    dataTable.Rows.Add(dataRow);
                }

                var sqlBulkCopy = CreateNewSqlBulkCopy(sqlConnection, dataTable.TableName);

                // This avoids identity insert issues, as these are db-generated.
                foreach (DataColumn column in dataTable.Columns)
                {
                    sqlBulkCopy.ColumnMappings.Add(column.ColumnName, column.ColumnName);
                }

                await sqlBulkCopy.WriteToServerAsync(dataTable);
            }
        }
    }
}