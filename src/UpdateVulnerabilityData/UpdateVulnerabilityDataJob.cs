// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Data.SqlClient;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using Autofac;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using NuGet.Jobs;
using NuGet.Jobs.Configuration;
using UpdateVulnerabilityData.CVE;
using UpdateVulnerabilityData.CWE;
using UpdateVulnerabilityData.Storage;

namespace UpdateVulnerabilityData
{
    internal class UpdateVulnerabilityDataJob : JsonConfigurationJob
    {
        private const string UpdateVulnerabilityDataConfigurationSectionName = "UpdateVulnerabilityDataConfiguration";

        public override async Task Run()
        {
            var logger = _serviceProvider.GetRequiredService<ILogger<UpdateVulnerabilityDataJob>>();
            var cweDataClient = _serviceProvider.GetRequiredService<ICweDataClient>();
            var cveDataClient = _serviceProvider.GetRequiredService<ICveDataClient>();
            var configuration = _serviceProvider.GetRequiredService<IOptionsSnapshot<UpdateVulnerabilityDataConfiguration>>().Value;

            logger.LogInformation("Execution mode: {ExecutionMode}", configuration.Mode);

            // Import the retrieved data into the gallery database.
            if (string.Equals(configuration.Mode, ExecutionMode.InitialInsert, StringComparison.OrdinalIgnoreCase))
            {
                Func<Task<SqlConnection>> openSqlConnectionFunction() => async () => await OpenSqlConnectionAsync<GalleryDbConfiguration>();

                // Import CVE data.
                await cveDataClient.ImportCveDataAsync(openSqlConnectionFunction(), CancellationToken.None);

                // Import CWE data.
                await cweDataClient.ImportCweDataAsync(openSqlConnectionFunction(), CancellationToken.None);
            }
            else
            {
                // todo: atomicity
                using (var sqlConnection = await OpenSqlConnectionAsync<GalleryDbConfiguration>())
                {
                    var entitiesContext = new VulnerabilityEntitiesContext(sqlConnection);

                    // todo


                    // Commit changes to the database.
                    await entitiesContext.SaveChangesAsync();
                }
            }
        }

        protected override void ConfigureAutofacServices(ContainerBuilder containerBuilder)
        {
        }

        protected override void ConfigureJobServices(IServiceCollection services, IConfigurationRoot configurationRoot)
        {
            ConfigureInitializationSection<UpdateVulnerabilityDataConfiguration>(services, configurationRoot);

            services.Configure<UpdateVulnerabilityDataConfiguration>(configurationRoot.GetSection(UpdateVulnerabilityDataConfigurationSectionName));

            services.AddTransient<ICweDataClient, CweDataClient>();
            services.AddTransient<ICweCsvFileParser, CweCsvFileParser>();
            services.AddTransient<ICweDataDownloader, CweDataDownloader>();

            services.AddTransient<ICveDataClient, CveDataClient>();
            services.AddTransient<ICveJsonFileParser, CveJsonFileParser>();
            services.AddTransient<ICveDataDownloader, CveDataDownloader>();

            services.AddSingleton<HttpClient>();
        }
    }
}